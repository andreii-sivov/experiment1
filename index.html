<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экспериментальное Исследование</title>
    <style>
        :root {
            --primary-color: #3a7ca5;
            --secondary-color: #81c3d7;
            --accent-color: #16425b;
            --text-color: #333;
            --light-bg: #f5f7fa;
            --white: #ffffff;
            --error: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --gray-light: #ecf0f1;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', 'Arial', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-bg);
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            width: 95%;
            margin: 20px auto;
            background: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .stage {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .stage.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        h1, h2, h3 {
            color: var(--accent-color);
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 25px;
        }
        
        h2 {
            font-size: 1.5rem;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
        }
        
        input[type="text"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(58, 124, 165, 0.1);
        }
        
        input[type="number"] {
            width: 80px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-block;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: var(--accent-color);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .radio-group,
        .likert-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
        }
        
        .radio-group:nth-child(odd),
        .likert-item:nth-child(odd) {
            background-color: #f1f1f1;
        }
        
        .radio-group label,
        .likert-item label {
            font-weight: normal;
            margin-right: 10px;
            display: inline-block;
        }
        
        .likert-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            max-width: 400px;
        }
        
        .likert-scale input[type="radio"] {
            margin: 0 10px;
        }
        
        .likert-labels {
            display: flex;
            justify-content: space-between;
            max-width: 400px;
            margin-bottom: 5px;
            font-size: 0.8em;
            color: #666;
        }
        
        #llmDialogArea {
            border: 1px solid #eee;
            padding: 15px;
            min-height: 200px;
            max-height: 350px;
            overflow-y: auto;
            background-color: #f9f9f9;
            margin-bottom: 15px;
            white-space: pre-wrap;
            border-radius: var(--border-radius);
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        .info-box {
            background-color: #e9f5ff;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .warning-box {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.8em;
            margin-bottom: 10px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                width: 100%;
                padding: 15px;
                margin: 10px auto;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .likert-scale {
                flex-wrap: wrap;
            }
            
            button {
                width: 100%;
            }
            
            .likert-labels span {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">Этап: 0/7</div>
        
        <!-- Этап 0: Добро пожаловать и ID участника -->
        <div id="stageWelcome" class="stage active">
            <h1>Экспериментальное Исследование</h1>
            <p>Добро пожаловать в наше исследование. Мы изучаем отношение людей к науке и научным явлениям.</p>
            <p>Ваше участие будет полностью анонимным. Все данные будут использоваться только в научных целях.</p>
            
            <form id="formWelcome">
                <div class="form-group">
                    <label for="participantId">Идентификатор участника:</label>
                    <input type="text" id="participantId" name="participantId" required placeholder="Введите ваш ID">
                    <small>Если у вас нет ID, система создаст его автоматически.</small>
                </div>
                <button type="button" onclick="nextStage('formWelcome', 'stageDemographics')">Начать исследование</button>
            </form>
        </div>

        <!-- Этап 1: Демографическая информация -->
        <div id="stageDemographics" class="stage">
            <h1>Демографическая информация</h1>
            <form id="formDemographics">
                <div class="form-group">
                    <label for="education">Уровень образования:</label>
                    <select id="education" name="education" required>
                        <option value="">--Выберите вариант--</option>
                        <option value="high_school">Среднее образование</option>
                        <option value="bachelors">Бакалавриат</option>
                        <option value="masters">Магистратура</option>
                        <option value="phd">Кандидат наук / PhD</option>
                        <option value="other">Другое</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="age">Возраст:</label>
                    <input type="number" id="age" name="age" min="18" max="100" required>
                </div>
                <div class="form-group">
                    <label for="residence">Место проживания (например, город, страна):</label>
                    <input type="text" id="residence" name="residence" required>
                </div>
                <button type="button" onclick="nextStage('formDemographics', 'stageTrust')">Далее</button>
            </form>
        </div>

        <!-- Этап 2: Доверие к институтам -->
        <div id="stageTrust" class="stage">
            <h1>Доверие к институтам</h1>
            <p>Укажите уровень вашего доверия к следующим институтам (1=Совсем не доверяю, 4=Полностью доверяю):</p>
            <form id="formTrust">
                <div class="form-group likert-item">
                    <p>Научное сообщество:</p>
                    <div class="likert-labels">
                        <span>Совсем не доверяю</span>
                        <span>Полностью доверяю</span>
                    </div>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="trust_science" value="1" required>
                        <input type="radio" name="trust_science" value="2">
                        <input type="radio" name="trust_science" value="3">
                        <input type="radio" name="trust_science" value="4">
                        <span>4</span>
                    </div>
                </div>
                <div class="form-group likert-item">
                    <p>Правительство:</p>
                    <div class="likert-labels">
                        <span>Совсем не доверяю</span>
                        <span>Полностью доверяю</span>
                    </div>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="trust_government" value="1" required>
                        <input type="radio" name="trust_government" value="2">
                        <input type="radio" name="trust_government" value="3">
                        <input type="radio" name="trust_government" value="4">
                        <span>4</span>
                    </div>
                </div>
                <div class="form-group likert-item">
                    <p>СМИ:</p>
                    <div class="likert-labels">
                        <span>Совсем не доверяю</span>
                        <span>Полностью доверяю</span>
                    </div>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="trust_media" value="1" required>
                        <input type="radio" name="trust_media" value="2">
                        <input type="radio" name="trust_media" value="3">
                        <input type="radio" name="trust_media" value="4">
                        <span>4</span>
                    </div>
                </div>
                <button type="button" onclick="nextStage('formTrust', 'stageNPSS_pre')">Далее</button>
            </form>
        </div>

        <!-- Этап 3: Восприятие науки (NPSS) - Предтест -->
        <div id="stageNPSS_pre" class="stage">
            <h1>Восприятие науки (предтест)</h1>
            <p>Укажите степень вашего согласия со следующими утверждениями (1=Полностью не согласен, 5=Полностью согласен):</p>
            <form id="formNPSS_pre">
                <div class="likert-labels">
                    <span>Полностью не согласен</span>
                    <span>Полностью согласен</span>
                </div>
                
                <div class="form-group likert-item">
                    <p>Ученые часто рассказывают не всю правду о своих научных открытиях.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_1" value="1" required>
                        <input type="radio" name="npss_pre_1" value="2">
                        <input type="radio" name="npss_pre_1" value="3">
                        <input type="radio" name="npss_pre_1" value="4">
                        <input type="radio" name="npss_pre_1" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Учёные часто подделывают данные, чтобы повлиять на результаты исследований и на выводы из них.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_2" value="1" required>
                        <input type="radio" name="npss_pre_2" value="2">
                        <input type="radio" name="npss_pre_2" value="3">
                        <input type="radio" name="npss_pre_2" value="4">
                        <input type="radio" name="npss_pre_2" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Наука обслуживает интересы корпораций.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_3" value="1" required>
                        <input type="radio" name="npss_pre_3" value="2">
                        <input type="radio" name="npss_pre_3" value="3">
                        <input type="radio" name="npss_pre_3" value="4">
                        <input type="radio" name="npss_pre_3" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Большинство ученых находятся под влиянием политики, предвзяты.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_4" value="1" required>
                        <input type="radio" name="npss_pre_4" value="2">
                        <input type="radio" name="npss_pre_4" value="3">
                        <input type="radio" name="npss_pre_4" value="4">
                        <input type="radio" name="npss_pre_4" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Учёные, как правило, высокомерны.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_5" value="1" required>
                        <input type="radio" name="npss_pre_5" value="2">
                        <input type="radio" name="npss_pre_5" value="3">
                        <input type="radio" name="npss_pre_5" value="4">
                        <input type="radio" name="npss_pre_5" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Наука слишком сложна для понимания.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_6" value="1" required>
                        <input type="radio" name="npss_pre_6" value="2">
                        <input type="radio" name="npss_pre_6" value="3">
                        <input type="radio" name="npss_pre_6" value="4">
                        <input type="radio" name="npss_pre_6" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Результаты научных исследований подают так, что их очень трудно понять.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_7" value="1" required>
                        <input type="radio" name="npss_pre_7" value="2">
                        <input type="radio" name="npss_pre_7" value="3">
                        <input type="radio" name="npss_pre_7" value="4">
                        <input type="radio" name="npss_pre_7" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Научный язык слишком сложен для понимания.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_8" value="1" required>
                        <input type="radio" name="npss_pre_8" value="2">
                        <input type="radio" name="npss_pre_8" value="3">
                        <input type="radio" name="npss_pre_8" value="4">
                        <input type="radio" name="npss_pre_8" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Меня не интересуют ответы на научные вопросы.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_9" value="1" required>
                        <input type="radio" name="npss_pre_9" value="2">
                        <input type="radio" name="npss_pre_9" value="3">
                        <input type="radio" name="npss_pre_9" value="4">
                        <input type="radio" name="npss_pre_9" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Научные открытия заставляют меня нервничать.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_10" value="1" required>
                        <input type="radio" name="npss_pre_10" value="2">
                        <input type="radio" name="npss_pre_10" value="3">
                        <input type="radio" name="npss_pre_10" value="4">
                        <input type="radio" name="npss_pre_10" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Священные писания (например, Библия) дают исчерпывающее объяснение устройства мира.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_11" value="1" required>
                        <input type="radio" name="npss_pre_11" value="2">
                        <input type="radio" name="npss_pre_11" value="3">
                        <input type="radio" name="npss_pre_11" value="4">
                        <input type="radio" name="npss_pre_11" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Не наука, а Бог — это высший способ познания.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_12" value="1" required>
                        <input type="radio" name="npss_pre_12" value="2">
                        <input type="radio" name="npss_pre_12" value="3">
                        <input type="radio" name="npss_pre_12" value="4">
                        <input type="radio" name="npss_pre_12" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Если бы люди доверяли Священным текстам, они бы знали все, что им нужно.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_13" value="1" required>
                        <input type="radio" name="npss_pre_13" value="2">
                        <input type="radio" name="npss_pre_13" value="3">
                        <input type="radio" name="npss_pre_13" value="4">
                        <input type="radio" name="npss_pre_13" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Религиозная доктрина объясняет нам всё, что нужно знать о мире.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_14" value="1" required>
                        <input type="radio" name="npss_pre_14" value="2">
                        <input type="radio" name="npss_pre_14" value="3">
                        <input type="radio" name="npss_pre_14" value="4">
                        <input type="radio" name="npss_pre_14" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Священного Писания достаточно, чтобы объяснить всё то, что важно.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_15" value="1" required>
                        <input type="radio" name="npss_pre_15" value="2">
                        <input type="radio" name="npss_pre_15" value="3">
                        <input type="radio" name="npss_pre_15" value="4">
                        <input type="radio" name="npss_pre_15" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Наука не способна объяснить всё.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_16" value="1" required>
                        <input type="radio" name="npss_pre_16" value="2">
                        <input type="radio" name="npss_pre_16" value="3">
                        <input type="radio" name="npss_pre_16" value="4">
                        <input type="radio" name="npss_pre_16" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Научный метод имеет ограничения.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_17" value="1" required>
                        <input type="radio" name="npss_pre_17" value="2">
                        <input type="radio" name="npss_pre_17" value="3">
                        <input type="radio" name="npss_pre_17" value="4">
                        <input type="radio" name="npss_pre_17" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Научные принципы не всегда разумны.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_18" value="1" required>
                        <input type="radio" name="npss_pre_18" value="2">
                        <input type="radio" name="npss_pre_18" value="3">
                        <input type="radio" name="npss_pre_18" value="4">
                        <input type="radio" name="npss_pre_18" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>В науке много противоречаших друг другу результатов.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_19" value="1" required>
                        <input type="radio" name="npss_pre_19" value="2">
                        <input type="radio" name="npss_pre_19" value="3">
                        <input type="radio" name="npss_pre_19" value="4">
                        <input type="radio" name="npss_pre_19" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Наука имеет серьёзные ограничения.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_pre_20" value="1" required>
                        <input type="radio" name="npss_pre_20" value="2">
                        <input type="radio" name="npss_pre_20" value="3">
                        <input type="radio" name="npss_pre_20" value="4">
                        <input type="radio" name="npss_pre_20" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <button type="button" onclick="nextStage('formNPSS_pre', 'stageAntiScienceList_pre')">Далее</button>
            </form>
        </div>

        <!-- Этап 4: Антинаучные убеждения (предтест) -->
        <div id="stageAntiScienceList_pre" class="stage">
            <h1>Антинаучные убеждения (предтест)</h1>
            <p>Оцените степень вашего согласия со следующими утверждениями по шкале от 1 (Полностью не согласен) до 10 (Полностью согласен):</p>
            <form id="formAntiScienceList_pre">
                <div class="form-group">
                    <label for="as_belief1_pre">Люди не причастны к глобальному потеплению и изменению климата.</label>
                    <input type="number" id="as_belief1_pre" name="as_belief1_pre" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief2_pre">Вакцины вредны для здоровья и могут вызывать болезни.</label>
                    <input type="number" id="as_belief2_pre" name="as_belief2_pre" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief3_pre">У людей нет общих предков с другими животными.</label>
                    <input type="number" id="as_belief3_pre" name="as_belief3_pre" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief4_pre">Астрологический знак (знак Зодиака) влияет на поведение человека.</label>
                    <input type="number" id="as_belief4_pre" name="as_belief4_pre" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief5_pre">Гомеопатия может помочь в лечении многих болезней.</label>
                    <input type="number" id="as_belief5_pre" name="as_belief5_pre" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief6_pre">Генномодифицированные продукты (ГМО) вредны для здоровья.</label>
                    <input type="number" id="as_belief6_pre" name="as_belief6_pre" min="1" max="10" required>
                </div>
                <button type="button" onclick="processAntiScienceListAndNext('formAntiScienceList_pre', 'stagePersonalBelief')">Далее</button>
            </form>
        </div>

        <!-- Этап 5: Формулировка личного убеждения -->
        <div id="stagePersonalBelief" class="stage">
            <h1>Сформулируйте личное убеждение</h1>
            <div class="info-box">
                <p>На основе ваших предыдущих ответов, одно из ваших более выраженных антинаучных убеждений, по-видимому, связано с:
                <strong id="predominantBeliefTopic"></strong>.</p>
                <p>Пожалуйста, сформулируйте это убеждение своими словами. "ИИ-ассистент" поможет вам его уточнить.</p>
            </div>
            <form id="formPersonalBelief">
                <div class="form-group">
                    <label for="personal_belief_text">Ваша формулировка убеждения:</label>
                    <textarea id="personal_belief_text" name="personal_belief_text" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="personal_belief_confidence_pre">Насколько вы уверены в этом убеждении (1-100)?</label>
                    <input type="number" id="personal_belief_confidence_pre" name="personal_belief_confidence_pre" min="1" max="100" required>
                </div>
                <button type="button" onclick="nextStage('formPersonalBelief', 'stageCentrality')">Далее</button>
            </form>
        </div>

        <!-- Этап 6: Центральность убеждения -->
        <div id="stageCentrality" class="stage">
            <h1>Центральность Вашего Убеждения</h1>
            <p>Относительно убеждения, которое вы только что сформулировали, укажите свое согласие (1=Полностью не согласен, 7=Полностью согласен):</p>
            <form id="formCentrality">
                <div class="form-group likert-item">
                    <p>Это убеждение является центральным для того, кем я являюсь.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="centrality_1" value="1" required>
                        <input type="radio" name="centrality_1" value="2">
                        <input type="radio" name="centrality_1" value="3">
                        <input type="radio" name="centrality_1" value="4">
                        <input type="radio" name="centrality_1" value="5">
                        <input type="radio" name="centrality_1" value="6">
                        <input type="radio" name="centrality_1" value="7">
                        <span>7</span>
                    </div>
                </div>
                <div class="form-group likert-item">
                    <p>Я бы чувствовал себя другим человеком, если бы больше не придерживался этого убеждения.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="centrality_2" value="1" required>
                        <input type="radio" name="centrality_2" value="2">
                        <input type="radio" name="centrality_2" value="3">
                        <input type="radio" name="centrality_2" value="4">
                        <input type="radio" name="centrality_2" value="5">
                        <input type="radio" name="centrality_2" value="6">
                        <input type="radio" name="centrality_2" value="7">
                        <span>7</span>
                    </div>
                </div>
                <div class="form-group likert-item">
                    <p>Это убеждение важно для моего самоощущения.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="centrality_3" value="1" required>
                        <input type="radio" name="centrality_3" value="2">
                        <input type="radio" name="centrality_3" value="3">
                        <input type="radio" name="centrality_3" value="4">
                        <input type="radio" name="centrality_3" value="5">
                        <input type="radio" name="centrality_3" value="6">
                        <input type="radio" name="centrality_3" value="7">
                        <span>7</span>
                    </div>
                </div>
                <button type="button" onclick="nextStage('formCentrality', 'stageRandomization')">Начать экспериментальную фазу</button>
            </form>
        </div>

        <!-- Этап 7: Рандомизация и экспериментальная фаза -->
        <div id="stageRandomization" class="stage">
            <h1>Рандомизация</h1>
            <p>Сейчас вы будете случайным образом распределены в группу для следующей фазы исследования. Пожалуйста, подождите...</p>
        </div>

        <!-- Контрольная группа -->
        <div id="stageControlGroup" class="stage">
            <h1>Контрольная группа: Задание на чтение</h1>
            <div class="info-box">
                <p>Ваше преобладающее антинаучное убеждение связано с: <strong id="controlGroupBeliefTopic"></strong>.</p>
                <p>Пожалуйста, внимательно прочитайте следующий текст. Он основан на научных исследованиях по этой теме. У вас есть 5 минут.</p>
            </div>
            <div id="controlGroupText" style="border:1px solid #ccc; padding:15px; margin-bottom:15px; height:300px; overflow-y:auto; border-radius:8px;"></div>
            <p>Оставшееся время: <span id="controlTimer">300</span> секунд</p>
            <button type="button" id="controlGroupDoneButton" style="display:none;" onclick="nextStage('stageControlGroup', 'stagePostTest1')">Продолжить</button>
        </div>

        <!-- Экспериментальная группа -->
        <div id="stageExperimentalGroup" class="stage">
            <h1>Экспериментальная группа: Диалог с ИИ</h1>
            <div class="info-box">
                <p>Ваше преобладающее антинаучное убеждение связано с: <strong id="experimentalGroupBeliefTopic"></strong>.</p>
                <p>Теперь вы проведете три раунда диалога с ИИ. В каждом раунде у вас будет время (примерно 5 минут) на формулировку аргумента, на который ИИ ответит.</p>
            </div>
            <h3 id="llmRoundTitle">Раунд 1 из 3</h3>
            <div id="llmDialogArea">
                <!-- Здесь появится история диалога -->
            </div>
            <div class="form-group">
                <label for="llmUserInput">Ваш аргумент/утверждение для этого раунда:</label>
                <textarea id="llmUserInput" rows="3"></textarea>
            </div>
            <button type="button" id="llmSendButton" onclick="handleLLMSend()">Отправить ИИ</button>
            <button type="button" id="llmNextRoundButton" style="display:none;" onclick="nextLLMRound()">Начать следующий раунд</button>
            <button type="button" id="llmToPostTestButton" style="display:none;" onclick="finalizeLLMStage()">Продолжить</button>
        </div>

        <!-- Пост-тест -->
        <div id="stagePostTest1" class="stage">
            <h1>Пост-тест</h1>
            <form id="formPostTest1">
                <div class="form-group">
                    <label for="personal_belief_confidence_post1">Переоценка вашего сформулированного убеждения: "<span id="personalBeliefTextDisplay_post1"></span>".
                    <br>Насколько вы уверены СЕЙЧАС в этом убеждении (1-100)?</label>
                    <input type="number" id="personal_belief_confidence_post1" name="personal_belief_confidence_post1" min="1" max="100" required>
                </div>
                <hr>
                <h3>Антинаучные убеждения (пост-тест)</h3>
                <p>Пожалуйста, снова оцените степень вашего согласия (1=Полностью не согласен, 10=Полностью согласен):</p>
                
                <div class="form-group">
                    <label for="as_belief1_post1">Люди не причастны к глобальному потеплению и изменению климата.</label>
                    <input type="number" id="as_belief1_post1" name="as_belief1_post1" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief2_post1">Вакцины вредны для здоровья и могут вызывать болезни.</label>
                    <input type="number" id="as_belief2_post1" name="as_belief2_post1" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief3_post1">У людей нет общих предков с другими животными.</label>
                    <input type="number" id="as_belief3_post1" name="as_belief3_post1" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief4_post1">Астрологический знак (знак Зодиака) влияет на поведение человека.</label>
                    <input type="number" id="as_belief4_post1" name="as_belief4_post1" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief5_post1">Гомеопатия может помочь в лечении многих болезней.</label>
                    <input type="number" id="as_belief5_post1" name="as_belief5_post1" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <label for="as_belief6_post1">Генномодифицированные продукты (ГМО) вредны для здоровья.</label>
                    <input type="number" id="as_belief6_post1" name="as_belief6_post1" min="1" max="10" required>
                </div>
                
                <hr>
                <h3>Восприятие науки (NPSS - пост-тест)</h3>
                <p>Пожалуйста, снова укажите степень вашего согласия (1=Полностью не согласен, 5=Полностью согласен):</p>
                
                <div class="form-group likert-item">
                    <p>Ученые часто рассказывают не всю правду о своих научных открытиях.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_post1_1" value="1" required>
                        <input type="radio" name="npss_post1_1" value="2">
                        <input type="radio" name="npss_post1_1" value="3">
                        <input type="radio" name="npss_post1_1" value="4">
                        <input type="radio" name="npss_post1_1" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Учёные часто подделывают данные, чтобы повлиять на результаты исследований и на выводы из них.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_post1_2" value="1" required>
                        <input type="radio" name="npss_post1_2" value="2">
                        <input type="radio" name="npss_post1_2" value="3">
                        <input type="radio" name="npss_post1_2" value="4">
                        <input type="radio" name="npss_post1_2" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <div class="form-group likert-item">
                    <p>Наука обслуживает интересы корпораций.</p>
                    <div class="likert-scale">
                        <span>1</span>
                        <input type="radio" name="npss_post1_3" value="1" required>
                        <input type="radio" name="npss_post1_3" value="2">
                        <input type="radio" name="npss_post1_3" value="3">
                        <input type="radio" name="npss_post1_3" value="4">
                        <input type="radio" name="npss_post1_3" value="5">
                        <span>5</span>
                    </div>
                </div>
                
                <button type="button" onclick="nextStage('formPostTest1', 'stageEnd')">Отправить</button>
            </form>
        </div>

        <!-- Конец -->
        <div id="stageEnd" class="stage">
            <h1>Исследование завершено</h1>
            <p>Благодарим за ваше участие в этом исследовании. Все собранные данные были сохранены.</p>
            <p>Ваши ответы внесут важный вклад в наше понимание восприятия научных явлений.</p>
            <button type="button" onclick="exportData()">Отправить данные</button>
        </div>
    </div>

    <script>
        // --- КОНФИГУРАЦИЯ ---
        // Если вы не планируете использовать ИИ, можно установить эту переменную в false
        const ENABLE_AI_FEATURES = false; 
        const OPENROUTER_API_KEY = ""; // Оставляем пустым, так как возникли проблемы с аутентификацией
        const OPENROUTER_MODEL = "google/gemini-flash-1.5";
        const YOUR_SITE_NAME_FOR_OPENROUTER = "ExperimentStudyRu";

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let currentStageId = 'stageWelcome';
        const participantData = {
            id: '',
            timestamps: {},
            responses: {},
            llmDialog: []
        };
        let predominantBelief = { text: "Еще не определено", topicName: "Н/Д" };
        let isExperimentalGroup = false;
        let llmRound = 1;
        let totalStages = 7; // Количество основных этапов

        const aiControlTexts = {
            "Глобальное потепление и изменение климата": "Научный консенсус указывает на то, что деятельность человека, в первую очередь сжигание ископаемого топлива, является основной причиной нынешнего глобального потепления. Многочисленные доказательства, включая повышение глобальной температуры, таяние ледников и изменения в режимах осадков, подтверждают этот вывод. Международные организации, такие как МГЭИК, обобщают обширные исследования для предоставления комплексных оценок.",
            "Вакцины": "Десятилетия обширных исследований и наблюдений со стороны глобальных организаций здравоохранения показали, что вакцины исключительно безопасны и эффективны для предотвращения инфекционных заболеваний. Преимущества вакцинации в защите отдельных лиц и сообществ значительно перевешивают редкие и обычно легкие риски побочных эффектов. Утверждения, связывающие вакцины с такими состояниями, как аутизм, были полностью опровергнуты многочисленными исследованиями.",
            "Эволюция человека": "Теория эволюции путем естественного отбора, подтвержденная обширными доказательствами из генетики, ископаемых, сравнительной анатомии и эмбриологии, показывает, что люди имеют общих предков с другими животными. Наша ДНК удивительно схожа с ДНК других приматов, а ископаемые свидетельства документируют постепенный переход видов гоминид на протяжении миллионов лет.",
            "Астрология": "Научные исследования последовательно не находят никаких доказательств того, что астрологические знаки (знаки Зодиака) оказывают заметное влияние на личность человека или жизненные события. Предсказания, сделанные астрологией, обычно расплывчаты и статистически не более точны, чем случайность. Понимается, что личность формируется сложным взаимодействием генетических и экологических факторов.",
            "Гомеопатия": "Гомеопатия - это система альтернативной медицины, основанная на принципе 'подобное лечится подобным' и последовательных разведениях. Многочисленные высококачественные научные обзоры и мета-анализы пришли к выводу, что гомеопатия не более эффективна, чем плацебо, для любого медицинского состояния. Ее предлагаемые механизмы действия не соответствуют установленным принципам физики и химии.",
            "ГМО": "Крупные международные научные организации, включая Всемирную организацию здравоохранения и Национальную академию наук, пришли к выводу, что генетически модифицированные (ГМ) продукты, доступные в настоящее время, безопасны для употребления. Во многих странах проводятся обширные испытания и регуляторный надзор. Технологии ГМ могут предлагать такие преимущества, как повышение урожайности и улучшение питательного содержания."
        };
        const beliefLabels = [
            "Люди не причастны к глобальному потеплению и изменению климата", 
            "Вакцины вредны для здоровья и могут вызывать болезни", 
            "У людей нет общих предков с другими животными", 
            "Астрологический знак (знак Зодиака) влияет на поведение человека", 
            "Гомеопатия может помочь в лечении многих болезней", 
            "Генномодифицированные продукты (ГМО) вредны для здоровья"
        ];
        
        const beliefTopics = [
            "Глобальное потепление и изменение климата",
            "Вакцины",
            "Эволюция человека",
            "Астрология",
            "Гомеопатия",
            "ГМО"
        ];

        // --- ОСНОВНЫЕ ФУНКЦИИ ---
        function updateProgressBar(currentStage) {
            // Карта этапов для прогресс-бара
            const stageMap = {
                'stageWelcome': 0,
                'stageDemographics': 1,
                'stageTrust': 2,
                'stageNPSS_pre': 3,
                'stageAntiScienceList_pre': 4,
                'stagePersonalBelief': 5,
                'stageCentrality': 6,
                'stageRandomization': 6,
                'stageControlGroup': 6,
                'stageExperimentalGroup': 6,
                'stagePostTest1': 7,
                'stageEnd': 7
            };
            
            const currentProgress = stageMap[currentStage] || 0;
            const percentage = (currentProgress / totalStages) * 100;
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `Этап: ${currentProgress}/${totalStages}`;
        }

        function logData(stageName, data) {
            participantData.timestamps[stageName] = new Date().toISOString();
            participantData.responses[stageName] = data;
            console.log(`Данные записаны для ${stageName}:`, JSON.parse(JSON.stringify(data)));
        }

        function showStage(stageId) {
            document.querySelectorAll('.stage').forEach(stage => stage.classList.remove('active'));
            const nextStageElement = document.getElementById(stageId);
            if (nextStageElement) {
                nextStageElement.classList.add('active');
                currentStageId = stageId;
                updateProgressBar(stageId);
                window.scrollTo(0,0);
            } else {
                console.error("Попытка показать несуществующий этап:", stageId);
            }
        }

        function collectFormData(formId) {
            const form = document.getElementById(formId);
            if (!form) {
                console.error("Форма не найдена:", formId);
                return {};
            }
            if (!form.checkValidity()) {
                alert("Пожалуйста, заполните все обязательные поля корректно.");
                form.reportValidity();
                return null;
            }
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) data[key] = [data[key]];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }
            return data;
        }

        function nextStage(currentFormIdOrStageId, nextStageId) {
            let data = {};
            let stageToLog = currentFormIdOrStageId;

            const currentElement = document.getElementById(currentFormIdOrStageId);
            if (!currentElement) {
                console.error("Текущий элемент не найден:", currentFormIdOrStageId);
                return;
            }

            if (currentElement.tagName === 'FORM') {
                data = collectFormData(currentFormIdOrStageId);
                if (data === null) return;
                
                // Специальная обработка для приветственной формы с ID участника
                if (currentFormIdOrStageId === 'formWelcome') {
                    if (data.participantId && data.participantId.trim() !== '') {
                        participantData.id = data.participantId.trim();
                    } else {
                        participantData.id = 'participant_' + Date.now() + Math.random().toString(36).substring(2,7);
                        data.participantId = participantData.id; // Сохраняем автоматически созданный ID
                    }
                }
                
                // Выводим имя этапа из ID формы, если она следует шаблону 'form[StageName]'
                if (currentFormIdOrStageId.startsWith('form')) {
                    stageToLog = 'stage' + currentFormIdOrStageId.substring(4);
                }
                logData(stageToLog, data);
            } else if (currentElement.classList.contains('stage')) {
                const formInStage = currentElement.querySelector('form');
                if (formInStage && formInStage.id) {
                    data = collectFormData(formInStage.id);
                    if (data === null) return;
                    logData(currentFormIdOrStageId, data);
                } else {
                    logData(currentFormIdOrStageId, { progressed: true }); // Нет формы, просто записываем прогресс
                }
            }

            // Специальная обработка для переходов
            if (nextStageId === 'stageRandomization') {
                performRandomization(); // Этот метод покажет свой собственный этап после таймаута
                return; // Не вызывать showStage пока
            } else if (nextStageId === 'stagePostTest1') {
                const beliefText = participantData.responses.stagePersonalBelief?.personal_belief_text || "Ваше ранее сформулированное убеждение";
                document.getElementById('personalBeliefTextDisplay_post1').textContent = beliefText;
            }
            showStage(nextStageId);
        }

        function processAntiScienceListAndNext(formId, nextStageId) {
            const data = collectFormData(formId);
            if (data === null) return;
            logData(formId.replace('form', 'stage'), data); // Логируем с именем этапа

            let maxScore = 0;
            let predominantIndex = -1;
            
            // Проверяем каждое убеждение, чтобы найти самое сильное
            for (let i = 1; i <= 6; i++) {
                const score = parseInt(data[`as_belief${i}_pre`] || 0);
                if (score > maxScore) {
                    maxScore = score;
                    predominantIndex = i - 1; // Индексы массива с 0
                }
            }

            if (predominantIndex !== -1) {
                predominantBelief.text = beliefLabels[predominantIndex];
                predominantBelief.topicName = beliefTopics[predominantIndex];
            } else {
                predominantBelief.text = "Конкретное преобладающее убеждение не выявлено; по умолчанию используется изменение климата.";
                predominantBelief.topicName = "Глобальное потепление и изменение климата";
            }
            
            participantData.predominantBeliefResolved = predominantBelief; // Логируем результат
            document.getElementById('predominantBeliefTopic').textContent = predominantBelief.topicName;
            showStage(nextStageId);
        }

        function performRandomization() {
            // Данные для stageCentrality должны быть уже записаны кнопкой 'Далее'
            showStage('stageRandomization'); // Показываем сообщение об ожидании рандомизации
            setTimeout(() => {
                isExperimentalGroup = Math.random() < 0.5;
                participantData.assignedGroup = isExperimentalGroup ? 'Экспериментальная' : 'Контрольная';
                logData('stageRandomization', { group: participantData.assignedGroup });

                if (isExperimentalGroup) {
                    document.getElementById('experimentalGroupBeliefTopic').textContent = predominantBelief.topicName;
                    llmRound = 1;
                    participantData.llmDialog = []; // Сбрасываем лог диалога для этого участника
                    document.getElementById('llmDialogArea').innerHTML = '';
                    document.getElementById('llmRoundTitle').textContent = `Раунд ${llmRound} из 3`;
                    document.getElementById('llmUserInput').value = '';
                    document.getElementById('llmSendButton').style.display = 'inline-block';
                    document.getElementById('llmSendButton').disabled = false;
                    document.getElementById('llmNextRoundButton').style.display = 'none';
                    document.getElementById('llmToPostTestButton').style.display = 'none';
                    showStage('stageExperimentalGroup');
                } else {
                    document.getElementById('controlGroupBeliefTopic').textContent = predominantBelief.topicName;
                    const controlText = aiControlTexts[predominantBelief.topicName] || "Здесь была бы представлена стандартная научная информация по выбранной теме.";
                    document.getElementById('controlGroupText').textContent = controlText;
                    showStage('stageControlGroup');
                    startControlTimer(300); // 5 минут (300 секунд)
                }
            }, 1500); // Симулируем процесс рандомизации
        }

        let timerInterval;
        function startControlTimer(duration) {
            let timer = duration;
            const timerDisplay = document.getElementById('controlTimer');
            document.getElementById('controlGroupDoneButton').style.display = 'none';
            if (timerInterval) clearInterval(timerInterval); // Очищаем любой существующий таймер
            timerInterval = setInterval(() => {
                timer--;
                timerDisplay.textContent = timer;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "0";
                    console.log("Время чтения для контрольной группы закончилось.");
                    document.getElementById('controlGroupDoneButton').style.display = 'inline-block';
                }
            }, 1000);
        }

        async function handleLLMSend() {
            const userInput = document.getElementById('llmUserInput').value.trim();
            if (!userInput) {
                alert("Пожалуйста, введите ваш аргумент.");
                return;
            }

            participantData.llmDialog.push({ round: llmRound, type: 'user', text: userInput, timestamp: new Date().toISOString() });
            updateLLMDialogArea(`Пользователь: ${userInput}`);
            document.getElementById('llmUserInput').value = ''; // Очищаем поле ввода

            const sendButton = document.getElementById('llmSendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'ИИ отвечает...';

            // Если функции ИИ отключены, используем заготовленные ответы
            if (!ENABLE_AI_FEATURES) {
                setTimeout(() => {
                    const predefinedResponses = [
                        "Это интересное мнение. Наука показывает, что существует множество доказательств, подтверждающих научную точку зрения. Возможно, стоит рассмотреть данные с разных сторон?",
                        "Я понимаю вашу точку зрения. Однако, научные исследования предлагают альтернативное объяснение. Большинство экспертов сходятся во мнении, что основанный на доказательствах подход является наиболее надежным.",
                        "Это распространенное мнение, но современные научные данные указывают на другие выводы. Критическое мышление и анализ различных источников могут помочь сформировать более полное представление."
                    ];
                    
                    const aiResponse = predefinedResponses[Math.floor(Math.random() * predefinedResponses.length)];
                    
                    participantData.llmDialog.push({ round: llmRound, type: 'ai', text: aiResponse, timestamp: new Date().toISOString() });
                    updateLLMDialogArea(`ИИ: ${aiResponse}`);
                    
                    sendButton.textContent = 'Отправить ИИ';
                    sendButton.style.display = 'none';
                    
                    if (llmRound < 3) {
                        document.getElementById('llmNextRoundButton').style.display = 'inline-block';
                        document.getElementById('llmNextRoundButton').disabled = false;
                    } else {
                        document.getElementById('llmToPostTestButton').style.display = 'inline-block';
                        document.getElementById('llmToPostTestButton').disabled = false;
                    }
                }, 1500); // Имитация задержки ответа ИИ
                
                return;
            }

            const messages = [
                {
                    role: "system",
                    content: `Вы ИИ-ассистент в исследовательском проекте. Пользователь обсуждает убеждение, потенциально связанное с "${predominantBelief.topicName}". Отвечайте на их аргумент фактически и уважительно. Поощряйте критическое мышление. Держите ответы краткими. Это раунд ${llmRound} из 3.`
                },
                { role: "user", content: userInput }
            ];

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json",
                        "X-Title": YOUR_SITE_NAME_FOR_OPENROUTER
                    },
                    body: JSON.stringify({
                        model: OPENROUTER_MODEL,
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: "Неизвестный формат ошибки API."}}));
                    throw new Error(`Ошибка API: ${response.status} ${response.statusText} - ${errorData.error?.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0]?.message?.content || "Формат ответа ИИ был неожиданным.";

                participantData.llmDialog.push({ round: llmRound, type: 'ai', text: aiResponse, timestamp: new Date().toISOString() });
                updateLLMDialogArea(`ИИ: ${aiResponse}`);

            } catch (error) {
                console.error("Вызов LLM API не удался:", error);
                updateLLMDialogArea(`ИИ (Ошибка): Извините, произошла ошибка. (${error.message}). Пожалуйста, перейдите к следующему шагу или попробуйте снова, если есть такая возможность.`);
                participantData.llmDialog.push({ round: llmRound, type: 'error', text: error.toString(), timestamp: new Date().toISOString() });
            } finally {
                sendButton.textContent = 'Отправить ИИ'; // Сбрасываем текст кнопки
                // Логика видимости кнопок:
                sendButton.style.display = 'none'; // Скрываем кнопку отправки после отправки в этом раунде
                if (llmRound < 3) {
                    document.getElementById('llmNextRoundButton').style.display = 'inline-block';
                    document.getElementById('llmNextRoundButton').disabled = false;
                } else {
                    document.getElementById('llmToPostTestButton').style.display = 'inline-block';
                    document.getElementById('llmToPostTestButton').disabled = false;
                }
            }
        }

        function nextLLMRound() {
            llmRound++;
            document.getElementById('llmRoundTitle').textContent = `Раунд ${llmRound} из 3`;
            document.getElementById('llmUserInput').value = ''; // Очищаем для следующего раунда
            document.getElementById('llmSendButton').style.display = 'inline-block';
            document.getElementById('llmSendButton').disabled = false;
            document.getElementById('llmNextRoundButton').style.display = 'none';
        }

        function updateLLMDialogArea(text) {
            const dialogArea = document.getElementById('llmDialogArea');
            dialogArea.innerHTML += text + '\n\n';
            dialogArea.scrollTop = dialogArea.scrollHeight;
        }
        
        function finalizeLLMStage() {
            // Записываем, что взаимодействие с LLM завершено, перед переходом к пост-тесту
            logData('stageExperimentalGroup', { completed: true, dialogRounds: llmRound, fullDialog: participantData.llmDialog });
            nextStage('stageExperimentalGroup', 'stagePostTest1');
        }

        function exportData() {
            // Показываем пользователю, что данные отправляются
            alert("Отправка данных начата...");
            
            // Создаем копию данных для отправки - значительно упрощенную
            const dataToSend = {
                id: participantData.id,
                timestamp: new Date().toISOString(),
                group: participantData.assignedGroup || "Не определено",
                belief: {
                    topic: predominantBelief.topicName,
                    text: participantData.responses?.stagePersonalBelief?.personal_belief_text || "",
                    confidence_pre: participantData.responses?.stagePersonalBelief?.personal_belief_confidence_pre || "",
                    confidence_post: participantData.responses?.stagePostTest1?.personal_belief_confidence_post1 || ""
                },
                // Только основные результаты опросов
                demographics: participantData.responses?.stageDemographics || {},
                trust: participantData.responses?.stageTrust || {},
                npss_pre: participantData.responses?.stageNPSS_pre || {},
                as_beliefs_pre: participantData.responses?.stageAntiScienceList_pre || {},
                centrality: participantData.responses?.stageCentrality || {},
                npss_post: participantData.responses?.stagePostTest1 ? 
                    Object.keys(participantData.responses.stagePostTest1)
                        .filter(key => key.startsWith('npss_post'))
                        .reduce((obj, key) => {
                            obj[key] = participantData.responses.stagePostTest1[key];
                            return obj;
                        }, {}) : {},
                as_beliefs_post: participantData.responses?.stagePostTest1 ? 
                    Object.keys(participantData.responses.stagePostTest1)
                        .filter(key => key.startsWith('as_belief'))
                        .reduce((obj, key) => {
                            obj[key] = participantData.responses.stagePostTest1[key];
                            return obj;
                        }, {}) : {}
            };
            
            // Исключаем логи диалогов чтобы уменьшить размер
            if (participantData.assignedGroup === 'Экспериментальная') {
                dataToSend.llm_dialog_count = participantData.llmDialog ? participantData.llmDialog.length : 0;
                // Отправляем только краткую информацию о диалогах, а не весь текст
                dataToSend.llm_rounds_completed = llmRound;
            }
            
            const jsonData = JSON.stringify(dataToSend);
            console.log("Размер отправляемых данных: " + jsonData.length + " байт");
            
            // Если размер данных слишком большой, сразу переходим к скачиванию
            if (jsonData.length > 100000) { // ~100KB
                console.warn("Размер данных слишком большой для отправки");
                alert("Данные слишком объемные для отправки. Будет выполнено локальное сохранение.");
                downloadBackup();
                return;
            }
            
            // Устанавливаем таймаут в 30 секунд
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            
            // Пробуем отправить данные через формат FormData (более совместимый с Google Apps Script)
            const formData = new FormData();
            formData.append('data', jsonData);
            
            fetch('https://script.google.com/macros/s/AKfycbzbUu4U29vZrop4SNi62SfyVxJ0gFwfgbnP44GRAuWXGz8Yrz2LwsSUDKcW6-a-Fn-O/exec', {
                method: 'POST',
                body: formData,  // Используем FormData вместо прямой отправки JSON
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status} ${response.statusText}`);
                }
                return response.text(); // Обрабатываем как текст вместо JSON для большей надежности
            })
            .then(data => {
                let success = false;
                try {
                    // Пробуем распарсить JSON ответ, если он в таком формате
                    const jsonResponse = JSON.parse(data);
                    success = jsonResponse.success === true;
                } catch (e) {
                    // Если не JSON, проверяем содержит ли текст успешное сообщение
                    success = data.includes('success') || data.includes('Success') || data.includes('OK');
                }
                
                if (success) {
                    alert("Данные успешно отправлены! Спасибо за участие!");
                } else {
                    throw new Error("Неизвестный ответ сервера");
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Ошибка при отправке:', error);
                
                let errorMessage = "Произошла ошибка при отправке данных.\n\n";
                
                if (error.name === 'AbortError') {
                    errorMessage += "Превышено время ожидания (30 секунд). Сервер не ответил вовремя.";
                } else {
                    errorMessage += "Детали ошибки: " + error.message;
                }
                
                errorMessage += "\n\nДанные будут скачаны на ваше устройство. Пожалуйста, отправьте файл организатору исследования.";
                
                alert(errorMessage);
                downloadBackup();
            });
        }

        function downloadBackup() {
            try {
                const fullData = JSON.stringify(participantData, null, 2);
                const blob = new Blob([fullData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `participant_data_${participantData.id}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log("Резервное скачивание данных выполнено успешно");
            } catch (err) {
                console.error("Ошибка при скачивании данных:", err);
                alert("Не удалось скачать данные. Пожалуйста, свяжитесь с организатором исследования.");
            }
        }

        // --- ИНИЦИАЛИЗАЦИЯ ---
        document.addEventListener('DOMContentLoaded', () => {
            logData('experiment_start', { userAgent: navigator.userAgent, timestamp: new Date().toISOString() });
            if (!ENABLE_AI_FEATURES) {
                console.log("Функции ИИ отключены в настройках.");
            } else if (!OPENROUTER_API_KEY || OPENROUTER_API_KEY === "") {
                console.warn("Отсутствует API ключ OpenRouter. Функции ИИ не будут работать с реальным ИИ.");
            }
            updateProgressBar('stageWelcome');
            showStage(currentStageId);
        });
    </script>
</body>
</html>